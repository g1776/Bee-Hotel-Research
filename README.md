# Bee Hotel Research

## Gregory Glatzer

## The Pennsylvania State University

<img src="https://media2.giphy.com/media/U6YxrKZ84AfppW48r4/giphy.gif" width="100" height="100">

### Usage

The `src.main.py` file is used with a config file. This is the recommended usage. The config file is a .env file that contains values for the commandline arguments. The config file is specified with the `--config` argument. For example:

```bash
  python -m src.main --config .env
```

The config file can be modified to change the commandline arguments. For example, to change the video file, change the `VIDEO` variable in the `.env` file. To see the full list of available arguments and their default values, see the `src.config.py` file.

To quit the running program, press `q`, or kill the terminal running the program.

### Usage - GUI

There is also a GUI to run the app in the web browser, built with `streamlit`. This option can be used by running:

```bash
  python -m src.app
```

In the GUI you will be prompted to enter the path to your .env file. This is the same as the `--config` argument. You can further modify the config values before running in the GUI. The GUI will then run the program with the specified arguments.

## Methods

### Evaluation

The evaluation is done against the ground truth labels generated by a human. Human labels come in two flavors:

1. Events that are "instantaneous", ie they happen so fast that they the start and end timestamps are essentially the same.

2. Events that are "long", ie they happen over a period of time.

For each of these events we have the associated method for measuring if that event was found using the computer vision technique developed:

1. If an event exists in the Computer Vision results (CV) with the same Bee ID and is within a buffer of X seconds of the Ground Truth (GT), then the CV event is considered a True Positive.

2. If an event exists in the CV results with the same Bee ID as a long event, and is within the event, or within a buffer of X seconds of the event, then the CV event is considered a True Positive.

### Individual Bee Identification (IBI)

The concept behind individual bee identification (IBI) is based on the fact that solitary bees will claim a tube in the bee hotel. This means that the bee will return to the same tube every time it visits the bee hotel. This is a useful property because it allows us to identify individual bees. The IBI method is based on the following steps:

1. For each motion capture in the video, if the is not any more motion detected in that area of pixels (with a padding of 5 pixels) for 5 frames, then the bee is considered to havebe out of frame, and thus may have entered a tube.
2. After identifying that a bee has entered a tube, we must determine which tube it has entered. This is done by determining the closest tube to the bee's centroid. The closest tube is determined by the euclidean distance between the bee's centroid and the tube's centroid. Each tube is assigned a number, which in turn will be the bee's ID.

### Motion capture

Use OpenCV to detect motion in a video. This will be used to determine when a bee is present in the video. For a given input video log when the bee is present with a buffer of 5 second on each end.

Updates:

-   ** 1/23/2023**: Thoughts after watching 10am:

    -   increase contour window size (this could help reduce false positives, especially the blowing piece of tube material)
    -   decrease motion threshold
    -   increase size threshold (maybe not)
    -   Bees are getting lost in the shadows.
    -   Ignore any motion that is too far from the tubes (more than a tube radius away?).

-   **10/15/2022**: Introduced _pytesseract_ to extract text from the video. This will be used to determine the timestamp that motion was captured. Before I tried to convert frame number to timestamp, but the frame rate appeared to be inconsistent. Currently the text is extracted correctly about 90% of the time. This can easily be solved. We just design the placement of the timestamp to be conducive to text extraction - Have the Raspberry Pi place the timestamp out of the frame on a black background.

    I also noticed that the motion capture completely fails when there is wind. This shakes the entire image. This can be seen several times through the 12pm video. Perhaps some form of image stabilization is needed.

-   **10/13/2022**: I have been able to create a basic implementation of motion detection using OpenCV. There are several parameters to tune in an attempt to reduce false positives. These variables are:

    -   detection_rate: Number of frames to detect motion between. Defaults to 2.
    -   motion_threshold: Threshold for motion detection (higher threshold = more motion needed). Defaults to 10.
    -   min_contour_area: Minimum area of a contour to be considered motion. Defaults to 200.

    I have also made the a parameter to choose how long to wait to log another motion event. In other words, if there are 20 events in a span of 2 seconds, and the wait time is 2 seconds, then all these events will be represented in the log as a single event. I call this "logging_granularity".
